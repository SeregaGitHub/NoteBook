
                                            Подключение к запущенному контейнеру

  Иногда ошибки зависят от внешнего окружения — например, из-за неправильно собранного образа или из-за того, 
что другая система присылает некорректные данные. Для таких случаев нужно подключаться к уже запущенному приложению.

------------------------------------------------------------------------------------------------------------------------------------

                                                Настройка Dockerfile

    Чтобы к приложению можно было подключиться для отладки, необходимо запустить его со следующими параметрами.

-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:[номер порта для отладки] 


  Что указывается в параметрах:

-  transport=dt_socket — способ подключения к JVM, подключение будет происходить с помощью сокетов;
-  server=y — к приложению будут подключаться для отладки, а не наоборот;
-  suspend=n — JVM будет ждать, пока отладчик подключится для начала выполнения команд. Иначе выполнение начинается сразу же;
-  address=*:[номер порта] — номер порта для подключения. Обычно берётся +1 от порта, который используется для самого приложения.

------------------------------------------------------------------------------------------------------------------------------------

    Чтобы порт для отладки заработал в Docker-контейнере, необходимо в Dockerfile добавить информацию с настройками Java. 
Так как подключение происходит через отдельный порт, а сейчас приложение запускается на 8080 порту, для отладки будем использовать 8081.

- ENV JAVA_TOOL_OPTIONS -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:8081 

    Итоговый Dockerfile будет выглядеть примерно так:

FROM amazoncorretto:11-alpine-jdk
ENV JAVA_TOOL_OPTIONS -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:8081
COPY target/*.jar app.jar
ENTRYPOINT ["java","-jar","/app.jar"] 

    Теперь необходимо собрать образ:

- docker build -t dock_image .  

    После сборки образа, запустим контейнер и свяжем новый порт с портом контейнера.

- docker run --name dock_container -p 8081:8081 -p 8080:8080 dock_image 

    Всё прошло успешно, если после запуска контейнера в логах есть строка:

- Listening for transport dt_socket at address: 8081.

=====================================================================================================================================

                                        Настройка подключения в режиме отладки

  Теперь перейдём к настройке подключения в режиме отладки. 
- Откройте IDEA с кодом того проекта, к которому хотите подключиться. 
  В меню конфигураций запуска (рядом с run, стрелка вниз) выберите Edit Configurations….

- Нажмите на + в левом верхнем углу и в открывшемся меню — на Add New Configuration.

- Выберите Remote JVM Debug

- Задайте имя новой конфигурации. 

- В поле Host поставьте значение localhost (так как докер запущен локально), 
  в поле Port — 8081. 

- Убедитесь, что в пункте Use module classpath выбран модуль того приложения, к которому вы хотите подключиться, 
  а в разделе Command line arguments for remote JVM проставлены те же параметры, что были указаны в Dockerfile:

-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:8081 
# строка формируется автоматически 
# eсли есть несоответствие, его можно исправить вручную 

- Нажмите OK

------------------------------------------------------------------------------------------------------------------------------------

                                                    Подключение

- Убедитесь, что контейнер с приложением запущен. 

- Выберите созданную конфигурацию запуска и нажмите кнопку Debug(Shift + F9).

Строка Connected to the target VM укажет на то, что всё выполнено верно.

- Можете расставлять точки останова. 
  Например, поставить одну в контроллере и вызвать описанный в нём метод !!!